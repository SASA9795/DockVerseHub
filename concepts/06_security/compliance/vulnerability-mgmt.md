# Vulnerability Management for Docker Containers

**File Location:** `concepts/06_security/compliance/vulnerability-mgmt.md`

## Vulnerability Management Process

A systematic approach to identifying, assessing, treating, and reporting security vulnerabilities in container environments.

## Process Overview

### 1. Discovery and Identification

**Continuous Scanning**

```bash
# Automated daily scans
#!/bin/bash
# Daily vulnerability scan script

IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}")
RESULTS_DIR="/var/log/vuln-scans/$(date +%Y%m%d)"

mkdir -p "$RESULTS_DIR"

for image in $IMAGES; do
    echo "Scanning $image..."
    trivy image --format json --output "$RESULTS_DIR/${image//\//_}.json" "$image"
done

# Generate summary report
trivy image --format table --severity HIGH,CRITICAL $IMAGES > "$RESULTS_DIR/summary.txt"
```

**Registry Integration**

```yaml
# Harbor registry with vulnerability scanning
version: "3.8"
services:
  harbor:
    image: goharbor/harbor-core:latest
    environment:
      - TRIVY_IGNORE_UNFIXED=true
      - SCANNER_TRIVY_TIMEOUT=5m
```

### 2. Assessment and Prioritization

**Risk Matrix**

| Severity | Exploitability | Business Impact | Priority |
| -------- | -------------- | --------------- | -------- |
| Critical | High           | High            | P0 (24h) |
| High     | High           | Medium          | P1 (7d)  |
| Medium   | Low            | High            | P2 (30d) |
| Low      | Any            | Low             | P3 (90d) |

**Automated Triage**

```bash
# Vulnerability triage script
#!/bin/bash

CRITICAL_THRESHOLD=0
HIGH_THRESHOLD=5
MEDIUM_THRESHOLD=20

trivy image --format json myapp:latest | jq '
.Results[] |
select(.Vulnerabilities != null) |
.Vulnerabilities |
group_by(.Severity) |
map({severity: .[0].Severity, count: length}) |
from_entries
' > vulnerability-count.json

CRITICAL=$(jq -r '.CRITICAL // 0' vulnerability-count.json)
HIGH=$(jq -r '.HIGH // 0' vulnerability-count.json)
MEDIUM=$(jq -r '.MEDIUM // 0' vulnerability-count.json)

if [ "$CRITICAL" -gt "$CRITICAL_THRESHOLD" ]; then
    echo "FAIL: $CRITICAL critical vulnerabilities found"
    exit 1
elif [ "$HIGH" -gt "$HIGH_THRESHOLD" ]; then
    echo "WARN: $HIGH high vulnerabilities found"
    exit 1
fi

echo "PASS: Vulnerability thresholds met"
```

### 3. Treatment and Remediation

**Base Image Updates**

```dockerfile
# Regular base image updates
FROM node:16.20.1-alpine3.18  # Specific version
# Scheduled monthly updates

# Multi-stage build to reduce attack surface
FROM node:16.20.1-alpine3.18 AS builder
RUN apk update && apk upgrade
COPY package*.json ./
RUN npm ci --only=production

FROM node:16.20.1-alpine3.18 AS runtime
RUN apk update && apk upgrade && apk add --no-cache dumb-init
COPY --from=builder /app/node_modules ./node_modules
COPY . .
USER 1000
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "server.js"]
```

**Dependency Management**

```bash
# npm audit and fix
npm audit --audit-level high
npm audit fix

# yarn security audit
yarn audit --level high

# Python security scanning
safety check
pip-audit
```

**Patch Management Process**

```yaml
# GitLab CI vulnerability management
vulnerability-scan:
  stage: security
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  allow_failure: false

dependency-update:
  stage: maintenance
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm update
    - npm audit fix
    - docker build -t $CI_REGISTRY_IMAGE:updated .
    - trivy image $CI_REGISTRY_IMAGE:updated
```

### 4. Monitoring and Reporting

**Vulnerability Dashboard**

```python
# Python script for vulnerability metrics
import json
import subprocess
import matplotlib.pyplot as plt
from datetime import datetime

def get_vulnerability_metrics():
    images = subprocess.check_output(['docker', 'images', '--format', '{{.Repository}}:{{.Tag}}']).decode().strip().split('\n')

    metrics = {
        'total_images': len(images),
        'vulnerable_images': 0,
        'critical_vulns': 0,
        'high_vulns': 0,
        'medium_vulns': 0,
        'low_vulns': 0
    }

    for image in images:
        try:
            result = subprocess.check_output(['trivy', 'image', '--format', 'json', image])
            data = json.loads(result)

            has_vulns = False
            for result in data.get('Results', []):
                for vuln in result.get('Vulnerabilities', []):
                    has_vulns = True
                    severity = vuln.get('Severity', '').lower()
                    if severity in metrics:
                        metrics[f'{severity}_vulns'] += 1

            if has_vulns:
                metrics['vulnerable_images'] += 1

        except subprocess.CalledProcessError:
            continue

    return metrics

def generate_report(metrics):
    report = f"""
# Vulnerability Report - {datetime.now().strftime('%Y-%m-%d')}

## Summary
- Total Images: {metrics['total_images']}
- Vulnerable Images: {metrics['vulnerable_images']}
- Vulnerability Free: {metrics['total_images'] - metrics['vulnerable_images']}

## Vulnerability Breakdown
- Critical: {metrics['critical_vulns']}
- High: {metrics['high_vulns']}
- Medium: {metrics['medium_vulns']}
- Low: {metrics['low_vulns']}

## Risk Assessment
- Critical Risk Images: {metrics['critical_vulns']}
- Immediate Action Required: {metrics['critical_vulns'] + metrics['high_vulns']}
"""
    return report

if __name__ == "__main__":
    metrics = get_vulnerability_metrics()
    report = generate_report(metrics)
    print(report)
```

### 5. CI/CD Integration

**GitHub Actions Security Workflow**

```yaml
name: Security Scan

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 2 * * *" # Daily at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t test-image .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "test-image"
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check vulnerability threshold
        run: |
          CRITICAL=$(docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --format json test-image | \
            jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length')

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Critical vulnerabilities found: $CRITICAL"
            exit 1
          fi
```

**Jenkins Pipeline Security**

```groovy
pipeline {
    agent any

    stages {
        stage('Security Scan') {
            steps {
                script {
                    def image = docker.build("myapp:${env.BUILD_ID}")

                    // Vulnerability scanning
                    sh "trivy image --exit-code 1 --severity HIGH,CRITICAL ${image.id}"

                    // OWASP Dependency Check
                    dependencyCheckPublisher pattern: 'dependency-check-report.xml'
                }
            }
        }

        stage('Security Gates') {
            steps {
                script {
                    def scanResult = sh(
                        script: "trivy image --format json ${image.id}",
                        returnStdout: true
                    )

                    def vulnerabilities = readJSON text: scanResult
                    def critical = vulnerabilities.Results.sum { result ->
                        result.Vulnerabilities.count { vuln -> vuln.Severity == 'CRITICAL' }
                    }

                    if (critical > 0) {
                        error("Build failed: ${critical} critical vulnerabilities found")
                    }
                }
            }
        }
    }

    post {
        always {
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'security-reports',
                reportFiles: 'trivy-report.html',
                reportName: 'Security Scan Report'
            ])
        }
    }
}
```

## Vulnerability Response Procedures

### Critical Vulnerabilities (P0 - 24 hours)

1. **Immediate Assessment**

   - Determine exploitability
   - Assess business impact
   - Identify affected systems

2. **Containment**

   - Stop vulnerable containers if necessary
   - Implement temporary mitigations
   - Network isolation if required

3. **Remediation**

   - Apply security patches
   - Update base images
   - Rebuild and redeploy containers

4. **Verification**
   - Re-scan patched images
   - Validate fixes in staging
   - Monitor for exploitation attempts

### High Vulnerabilities (P1 - 7 days)

1. **Planning**

   - Schedule maintenance window
   - Prepare rollback procedures
   - Coordinate with stakeholders

2. **Testing**

   - Test patches in development
   - Validate application functionality
   - Performance impact assessment

3. **Deployment**
   - Rolling update deployment
   - Monitor system health
   - Verify vulnerability resolution

## Compliance and Reporting

### Regulatory Requirements

- **PCI DSS**: Quarterly vulnerability scans
- **HIPAA**: Regular risk assessments
- **SOX**: IT controls documentation
- **GDPR**: Privacy impact assessments

### Metrics and KPIs

```bash
# Vulnerability metrics collection
#!/bin/bash

# Time to detection
DETECTION_TIME=$(( $(date +%s) - $(docker inspect --format='{{.Created}}' image | xargs date -d | date +%s) ))

# Time to remediation
REMEDIATION_TIME=$(( $(date +%s) - $VULNERABILITY_DISCOVERY_TIME ))

# Vulnerability density
VULN_COUNT=$(trivy image --format json image | jq '[.Results[].Vulnerabilities[]] | length')
IMAGE_SIZE=$(docker inspect --format='{{.Size}}' image)
VULN_DENSITY=$(echo "scale=2; $VULN_COUNT * 1000000 / $IMAGE_SIZE" | bc)

echo "Detection Time: ${DETECTION_TIME}s"
echo "Remediation Time: ${REMEDIATION_TIME}s"
echo "Vulnerability Density: ${VULN_DENSITY} per MB"
```

### Executive Dashboard

```sql
-- Vulnerability trends query
SELECT
    DATE(scan_date) as date,
    COUNT(*) as total_vulnerabilities,
    SUM(CASE WHEN severity = 'CRITICAL' THEN 1 ELSE 0 END) as critical,
    SUM(CASE WHEN severity = 'HIGH' THEN 1 ELSE 0 END) as high,
    SUM(CASE WHEN severity = 'MEDIUM' THEN 1 ELSE 0 END) as medium,
    AVG(days_to_remediation) as avg_remediation_time
FROM vulnerability_scans
WHERE scan_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)
GROUP BY DATE(scan_date)
ORDER BY date DESC;
```

## Tools and Technologies

### Scanning Tools

- **Trivy**: Comprehensive vulnerability scanner
- **Clair**: Static vulnerability analysis
- **Anchore**: Policy-driven security analysis
- **Snyk**: Developer-first security platform
- **Docker Scout**: Docker's native scanning

### Integration Platforms

- **Harbor**: Enterprise registry with scanning
- **JFrog Xray**: Universal artifact analysis
- **Twistlock**: Container security platform
- **Aqua Security**: Full-stack container security

### Automation Scripts

```bash
# Automated patching workflow
#!/bin/bash

REGISTRY="myregistry.com"
REPO="myapp"

# Get list of images to update
IMAGES=$(curl -s "${REGISTRY}/v2/${REPO}/tags/list" | jq -r '.tags[]')

for tag in $IMAGES; do
    IMAGE="${REGISTRY}/${REPO}:${tag}"

    # Scan current image
    VULNS=$(trivy image --format json "$IMAGE" | jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length')

    if [ "$VULNS" -gt 0 ]; then
        echo "Patching $IMAGE (${VULNS} vulnerabilities)"

        # Rebuild with latest base image
        docker build --pull --no-cache -t "${IMAGE}-patched" .

        # Verify patch effectiveness
        NEW_VULNS=$(trivy image --format json "${IMAGE}-patched" | jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length')

        if [ "$NEW_VULNS" -lt "$VULNS" ]; then
            echo "Patch successful: $VULNS -> $NEW_VULNS vulnerabilities"
            docker tag "${IMAGE}-patched" "$IMAGE"
            docker push "$IMAGE"
        else
            echo "Patch ineffective for $IMAGE"
        fi
    fi
done
```

## Best Practices

1. **Automate Everything**

   - Continuous scanning
   - Automated patching
   - Policy enforcement

2. **Shift Left**

   - Scan in development
   - Pre-commit hooks
   - IDE integration

3. **Risk-Based Approach**

   - Prioritize by exploitability
   - Consider business context
   - Focus on critical paths

4. **Documentation**

   - Maintain vulnerability database
   - Track remediation efforts
   - Document exceptions

5. **Regular Reviews**
   - Monthly vulnerability reviews
   - Quarterly process assessment
   - Annual policy updates

This comprehensive vulnerability management process ensures systematic identification, assessment, and remediation of security vulnerabilities in containerized environments.
